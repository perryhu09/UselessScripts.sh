
#===============================================
# Antivirus
#===============================================

run_rootkit_scans() {
  log_action "=== RUNNING ROOTKIT SCANS ==="

  local RK_LOG="/var/log/rkhunter.log"
  local CRK_LOG="/var/log/chkrootkit.log"

  # Update package lists
  log_action "Updating package lists for rootkit scanner installation..."
  apt update -y -qq &>/dev/null

  # Install or reinstall rkhunter
  if ! dpkg -s rkhunter &>/dev/null; then
    log_action "Installing rkhunter..."
    DEBIAN_FRONTEND=noninteractive apt-get install -y -qq rkhunter &>/dev/null
    log_action "rkhunter installed successfully"
  else
    log_action "Reinstalling rkhunter for clean baseline..."
    DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --reinstall rkhunter &>/dev/null
    log_action "rkhunter reinstalled successfully"
  fi

  # Install or reinstall chkrootkit
  if ! dpkg -s chkrootkit &>/dev/null; then
    log_action "Installing chkrootkit..."
    DEBIAN_FRONTEND=noninteractive apt-get install -y -qq chkrootkit &>/dev/null
    log_action "chkrootkit installed successfully"
  else
    log_action "Reinstalling chkrootkit for clean baseline..."
    DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --reinstall chkrootkit &>/dev/null
    log_action "chkrootkit reinstalled successfully"
  fi

  # Configure rkhunter
  if [ -f /etc/rkhunter.conf ]; then
    backup_file /etc/rkhunter.conf
    log_action "Configuring rkhunter..."
    # Prefer mirror updates and quiet web fetches
    sed -i 's/^[#[:space:]]*UPDATE_MIRRORS=.*/UPDATE_MIRRORS=1/' /etc/rkhunter.conf 2>/dev/null || true
    sed -i 's/^[#[:space:]]*MIRRORS_MODE=.*/MIRRORS_MODE=1/' /etc/rkhunter.conf 2>/dev/null || true
    sed -i 's|^[#[:space:]]*WEB_CMD=.*|WEB_CMD="wget -q"|' /etc/rkhunter.conf 2>/dev/null || true
    log_action "rkhunter configuration updated"
  fi

  # Update rkhunter database
  log_action "Updating rkhunter signatures database..."
  rkhunter --update &>>"$RK_LOG" || true

  # Build baseline file property database
  log_action "Building rkhunter file property baseline..."
  rkhunter --propupd &>>"$RK_LOG" || true

  # Run rkhunter scan
  log_action "Starting rkhunter system scan (this may take several minutes)..."
  rkhunter --check --sk --nocolors --noappend-log &>>"$RK_LOG" || true
  log_action "rkhunter scan completed. Full log: $RK_LOG"

  # Run chkrootkit scan
  log_action "Starting chkrootkit system scan..."
  chkrootkit -q >"$CRK_LOG" 2>&1 || true
  log_action "chkrootkit scan completed. Full log: $CRK_LOG"

  # Append scan results to main log
  {
    echo "========== rkhunter Results (last 50 lines) =========="
    tail -n 50 "$RK_LOG" 2>/dev/null || echo "No rkhunter log found"
  } >>"$LOG_FILE" 2>/dev/null

  {
    echo "========== chkrootkit Results (last 50 lines) =========="
    tail -n 50 "$CRK_LOG" 2>/dev/null || echo "No chkrootkit log found"
  } >>"$LOG_FILE" 2>/dev/null

  # Basic alerting based on common warning patterns
  log_action "Analyzing scan results for suspicious findings..."
  local RK_ALERTS CRK_ALERTS
  RK_ALERTS=$(grep -Ei "Warning|suspect|infected|rootkit" "$RK_LOG" 2>/dev/null | wc -l)
  CRK_ALERTS=$(grep -Ei "INFECTED|Vulnerable|Warning" "$CRK_LOG" 2>/dev/null | wc -l)

  if [ "${RK_ALERTS:-0}" -gt 0 ] || [ "${CRK_ALERTS:-0}" -gt 0 ]; then
    log_action "ALERT: Potential security issues detected by rootkit scanners"
    log_action "ALERT: rkhunter warnings: ${RK_ALERTS}, chkrootkit warnings: ${CRK_ALERTS}"
    log_action "ALERT: Review full logs at $RK_LOG and $CRK_LOG"
  else
    log_action "No obvious rootkit indicators found in scans"
  fi

  log_action "Rootkit scanning complete"
}